/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2013 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.m.FacetFilterList");jQuery.sap.require("sap.m.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.m.FacetFilterList",{metadata:{publicMethods:["getSelectedItems"],library:"sap.m",properties:{"title":{type:"string",group:"Appearance",defaultValue:null},"allCount":{type:"int",group:"Misc",defaultValue:null},"active":{type:"boolean",group:"Behavior",defaultValue:true},"key":{type:"string",group:"Identification",defaultValue:null},"multiSelect":{type:"boolean",group:"Behavior",defaultValue:true},"sequence":{type:"int",group:"Behavior",defaultValue:-1},"growing":{type:"boolean",group:"Behavior",defaultValue:true},"growingThreshold":{type:"int",group:"Misc",defaultValue:20},"growingTriggerText":{type:"string",group:"Misc",defaultValue:null}},aggregations:{"items":{type:"sap.m.FacetFilterItem",multiple:true,singularName:"item"}},events:{"listOpen":{},"listClose":{}}}});sap.m.FacetFilterList.M_EVENTS={'listOpen':'listOpen','listClose':'listClose'};jQuery.sap.require("sap.m.List");jQuery.sap.require("sap.m.StandardListItem");jQuery.sap.require("sap.m.Button");jQuery.sap.require("sap.m.ButtonType");jQuery.sap.require("sap.ui.model.Filter");jQuery.sap.require("sap.ui.model.FilterOperator");
sap.m.FacetFilterList.prototype.init=function(){this._bundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");var t=this;this._list=new sap.m.List(this.getId()+"-filterlist",{growing:this.getGrowing(),growingThreshold:this.getGrowingThreshold(),growingTriggerText:this.getGrowingTriggerText(),showNoData:true,scrollToLoad:false,mode:this.getMultiSelect()?sap.m.ListMode.MultiSelect:sap.m.ListMode.SingleSelectMaster,selectionChange:function(e){t._handleSelectionChange(e)},updateFinished:function(e){t._updateFinished(e)},includeItemInSelection:true});this._searchField=new sap.m.SearchField(this.getId()+"-searchField",{width:"100%",placeholder:t._bundle.getText("FACETFILTER_SEARCH"),search:function(e){t._setItemsFilter()}});var h=new sap.m.Bar(this.getId()+"-headerbar",{contentMiddle:this._searchField});this._cbSelectAll=new sap.m.CheckBox(this.getId()+"-selectAll",{selected:true,text:this._bundle.getText("FACETFILTER_ALL",[""]),select:function(e){if(!e.getParameter("selected")){this.setSelected(true)}else{t._deselectAll();t._list.removeSelections(true)}}});this._popover=new sap.m.Popover(this.getId()+"-popup",{placement:sap.m.PlacementType.Bottom,showHeader:true,beforeOpen:function(e){if(t.getMultiSelect()&&!this.getSubHeader()){var s=new sap.m.Bar({contentLeft:t._cbSelectAll});this.setSubHeader(s)}this.setInitialFocus(t.getId()+"-searchField")},afterClose:function(e){t._handlePopoverCloseEvent(e)},horizontalScrolling:false,customHeader:h,content:[t._list]});this._popover.addStyleClass("sapMFFPop")};
sap.m.FacetFilterList.prototype.setGrowing=function(g){this._list.setGrowing(g);this.setProperty("growing",g)};
sap.m.FacetFilterList.prototype.setGrowingThreshold=function(g){this._list.setGrowingThreshold(g);this.setProperty("growingThreshold",g)};
sap.m.FacetFilterList.prototype.setGrowingTriggerText=function(g){this._list.setGrowingTriggerText(g);this.setProperty("growingTriggerText",g)};
sap.m.FacetFilterList.prototype._deselectAll=function(e){var f=this.getItems();jQuery.each(f,function(i,v){v.setProperty("selected",false,true)})};
sap.m.FacetFilterList.prototype._updateFinished=function(e){this._copySelectionToPopover()};
sap.m.FacetFilterList.prototype._handleSelectionChange=function(e){var v=e.getParameters().listItems;var m=this._modelName;var f=this.getItems();var t=this;jQuery.each(v,function(a,b){if(b&&!b.getBindingInfo("selected")){var p=b.getBindingContext(m).getPath();var s=!t.getMultiSelect();var F=false;for(var i=0;i<f.length;i++){if(!F&&f[i].getBindingContext(m).getPath()===p){f[i].setProperty("selected",e.getParameters().selected,true);F=true}else if(s){f[i].setProperty("selected",false,true)}}}});this._setCBSelectAll()};
sap.m.FacetFilterList.prototype._setItemsFilter=function(){var v=this._searchField.getValue();var b=this._list.getBinding("items");if(b){var p=this._list.getBindingInfo("items").template.getBindingInfo("title").parts[0].path;if(b&&p){var f=new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.Contains,v);b.filter([f]);this._copySelectionToPopover();this._setCBSelectAll()}}};
sap.m.FacetFilterList.prototype._applyPopoverPersonalization=function(){var t=this;if(this.getParent()){if(this.getParent().getShowPersonalization()){if(!this._deleteFilterButton){this._deleteFilterButton=new sap.m.Button(this.getId()+"-remove",{text:t._bundle.getText("FACETFILTER_REMOVE_FILTER"),width:"100%",press:function(){t.setActive(false);t._popover.close()}});this._popover.setFooter(this._deleteFilterButton)}}else{var b=this._popover.getFooter();if(b){this._popover.setFooter(null);b.destroy();delete this._deleteFilterButton}}}};
sap.m.FacetFilterList.prototype._copySelectionToPopover=function(){var l=this._list.getItems();var f=this.getItems();var m=this._modelName;var a=0;jQuery.each(f,function(b,v){if(!v.getBindingInfo("selected")){for(var i=a;i<l.length;i++){if(v.getBindingContext(m)&&v.getBindingContext(m).getPath()){var p=v.getBindingContext(m).getPath();if(l[i].getBindingContext(m)&&l[i].getBindingContext(m).getPath()===p){l[i].setSelected(v.getSelected());a=i;break}}}}})};
sap.m.FacetFilterList.prototype._displayFacetFilterPopover=function(e){this._applyPopoverPersonalization();this.fireListOpen({});this._copySelectionToPopover();this._setCBSelectAll();this._popover.openBy(this._getFacetButton())};
sap.m.FacetFilterList.prototype._handlePopoverCloseEvent=function(e){this._fireListCloseEvent()};
sap.m.FacetFilterList.prototype._fireListCloseEvent=function(){var s=this.getSelectedItems();if(this.getParent().getType()===sap.m.FacetFilterType.Simple){this._getFacetButton().setText(this._getSelectionText(s))}var a=s.length===this.getItems().length||s.length===0;this.fireListClose({selectedItems:s,allSelected:a})};
sap.m.FacetFilterList.prototype._getFacetButton=function(){if(!this._button){var t=this;this._button=new sap.m.Button({type:sap.m.ButtonType.Transparent,press:function(e){t._displayFacetFilterPopover(e)},id:this.getId()+"-button"});this._button.setParent(this.getParent())}return this._button};
sap.m.FacetFilterList.prototype.exit=function(){if(this._button){this._button.destroy();this._button=undefined}if(this._popover){this._popover.destroy();this._popover=undefined}if(this._cbSelectAll){this._cbSelectAll.destroy();this._cbSelectAll=undefined}};
sap.m.FacetFilterList.prototype.getSelectedItems=function(){var s=[];var l=this.getItems();if(l.length>0){for(var i=0;i<l.length;i++){if(l[i].getSelected()){s.push(l[i])}}}return s};
sap.m.FacetFilterList.prototype._getIndex=function(l){var c=l.getCustomData();for(var i=0;i<c.length;i++){if(c[i].getKey()==="index"){return c[i].getValue()}}};
sap.m.FacetFilterList.prototype.setMultiSelect=function(m){if(m||m===undefined||m===null){this._list.setMode(sap.m.ListMode.MultiSelect)}else{this._list.setMode(sap.m.ListMode.SingleSelectMaster)}this.setProperty("multiSelect",m,true)};
sap.m.FacetFilterList.prototype._getSelectionText=function(s){var t="";if(!s){s=this.getSelectedItems()}if(s.length>0&&s.length<this.getItems().length){if(s.length===1){t=this._bundle.getText("FACETFILTER_ONE_SELECTION",[this.getTitle(),s[0].getText()])}else{t=this._bundle.getText("FACETFILTER_SUM_SELECTIONS",[this.getTitle(),s.length])}}else{t=this._bundle.getText("FACETFILTER_ALL",[this.getTitle()])}return t};
sap.m.FacetFilterList.prototype.unbindAggregation=function(n,s){if(n==="items"){this._list.unbindAggregation(n,s)}sap.ui.base.ManagedObject.prototype.unbindAggregation.apply(this,arguments)};
sap.m.FacetFilterList.prototype.bindAggregation=function(n,b){if(n==="items"){var p,t,s,f;var S=new sap.m.StandardListItem();var i=typeof b=="string";if(i){p=arguments[1];t=arguments[2];s=arguments[3];f=arguments[4]}else{p=b.path;t=b.template;s=b.sorter;f=b.filters}var l={path:p,template:S,sorter:s,filters:f};var T=t.getBindingInfo("text");if(T){S.bindProperty("title",T)}if(t.getBindingInfo("count")){S.bindProperty("counter",t.getBindingInfo("count"))}if(t.getBindingInfo("selected")){S.bindProperty("selected",t.getBindingInfo("selected"))}sap.ui.base.ManagedObject.prototype.bindAggregation.apply(this,arguments);this._list.bindAggregation(n,l);if(this._modelSync){this._modelSync(this._list.getModel(this._modelName))}}else{sap.ui.base.ManagedObject.prototype.bindAggregation.apply(this,arguments)}};
sap.m.FacetFilterList.prototype.setBindingContext=function(c,n){this._list.setBindingContext(c,n);this._list.setModel(c.getModel());sap.ui.base.ManagedObject.prototype.setBindingContext.apply(this,arguments)};
sap.m.FacetFilterList.prototype.setModel=function(m,n){this._modelName=n;this._list.setModel(m,n);sap.ui.base.ManagedObject.prototype.setModel.apply(this,arguments)};
sap.m.FacetFilterList.prototype.addItem=function(i){if(!this.isBound("items")){this._addStandardListItem(i)}this.addAggregation("items",i,true);return this};
sap.m.FacetFilterList.prototype.removeAllItems=function(){if(!this.isBound("items")){this._list.removeAllAggregation("items")}return this.removeAllAggregation("items",true)};
sap.m.FacetFilterList.prototype.removeItem=function(i){if(!this.isBound("items")){this._list.removeItem(this._list.getItems()[this.indexOfItem(i)])}return this.removeAggregation("items",i,true)};
sap.m.FacetFilterList.prototype.destroyItems=function(i){if(!this.isBound("items")){this._list.destroyAggregation("items")}return this.destroyAggregation("items",true)};
sap.m.FacetFilterList.prototype._addStandardListItem=function(i){var s=new sap.m.StandardListItem({title:i.getText(),counter:i.getCount(),selected:i.getSelected()});this._list.addItem(s)};
sap.m.FacetFilterList.prototype._setCBSelectAll=function(){if(this.getMultiSelect()){var s=this.getSelectedItems().length;this._cbSelectAll.setSelected(s===0)}};
sap.m.FacetFilterList.prototype._setLiveSearch=function(l){if(l){this._searchField.attachLiveChange(this._setItemsFilter,this)}else{this._searchField.detachLiveChange(this._setItemsFilter,this)}};
