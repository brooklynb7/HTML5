/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2013 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.m.FacetFilter");jQuery.sap.require("sap.m.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.m.FacetFilter",{metadata:{publicMethods:["openFilterDialog"],library:"sap.m",properties:{"type":{type:"sap.m.FacetFilterType",group:"Appearance",defaultValue:sap.m.FacetFilterType.Simple},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"showPersonalization":{type:"boolean",group:"Behavior",defaultValue:false},"showSummaryBar":{type:"boolean",group:"Behavior",defaultValue:false},"showReset":{type:"boolean",group:"Behavior",defaultValue:true},"liveSearch":{type:"boolean",group:"Behavior",defaultValue:true}},defaultAggregation:"lists",aggregations:{"lists":{type:"sap.m.FacetFilterList",multiple:true,singularName:"list"}},events:{"reset":{}}}});sap.m.FacetFilter.M_EVENTS={'reset':'reset'};jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ui.core.Icon");sap.m.FacetFilter.SCROLL_STEP=264;
sap.m.FacetFilter.prototype.init=function(){var t=this;this._lastScrolling=false;this._bPreviousScrollForward=false;this._bPreviousScrollBack=false;this._bNavigationInProgress=false;this._bOkPressedDuringNavigate=false;this._bRtl=sap.ui.getCore().getConfiguration().getRTL();if(jQuery.sap.touchEventMode==="ON"&&!jQuery.device.is.phone){this._enableTouchSupport()}this._bundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._bOpenDialogInLiteFlow=true;this._resetIcon=new sap.ui.core.Icon(this.getId()+"-rb",{src:sap.ui.core.IconPool.getIconURI("undo"),press:function(e){t._handleResetPress(e)}});this._facetAddIcon=new sap.ui.core.Icon(this.getId()+"-add",{src:sap.ui.core.IconPool.getIconURI("add"),press:function(e){t._displayFacetDialog(e)}});this._facetAddIcon.addStyleClass("sapMFFAddIcon");var s=this._getType()===sap.m.FacetFilterType.Light?true:false;this._summaryBarText=new sap.m.Text(this.getId()+"-summaryBarTxt",{maxLines:1});this._summaryBar=new sap.m.Toolbar(this.getId()+"-summaryBar",{content:[this._summaryBarText,this._resetIcon],active:s,press:function(e){t._handleSummaryBarPress(e)}});var S=new sap.m.StandardListItem({title:"{text}",selected:"{selected}",counter:"{count}",customData:[new sap.ui.core.CustomData({key:"index",value:"{index}"})]});this._facetList=new sap.m.List(this.getId()+"-facetlist",{mode:sap.m.ListMode.SingleSelectMaster,items:{path:"/items",template:S},selectionChange:function(e){t._selectFacet(e)}});this._itemsList=new sap.m.List(this.getId()+"-itemlist",{mode:sap.m.ListMode.MultiSelect,selectionChange:function(e){t._handleSelectionChange(e)},includeItemInSelection:true,updateFinished:function(e){t._updateFinished(e)}});var f=new sap.m.SearchField(this.getId()+"-facetsSearchField",{width:"100%",placeholder:this._bundle.getText("FACETFILTER_SEARCH"),liveChange:function(e){var b=t._facetList.getBinding("items");if(b){var a=new sap.ui.model.Filter("text",sap.ui.model.FilterOperator.Contains,this.getValue());b.filter([a])}}});this._itemsSearchField=new sap.m.SearchField(this.getId()+"-itemsSearchField",{width:"100%",placeholder:this._bundle.getText("FACETFILTER_SEARCH"),search:function(e){t._handleItemsListLiveChange()}});this._cbSelectAll=new sap.m.CheckBox(this.getId()+"-selectAll",{selected:true,text:this._bundle.getText("FACETFILTER_ALL",[""]),select:function(e){if(!e.getParameter("selected")){this.setSelected(t.getLists()[t._currentFacetIndex].getActive())}else{t._itemsList.removeSelections(true);t._deselectAll()}}});this._navcon=new sap.m.NavContainer(this.getId()+"-navcon",{navigate:function(){t._bNavigationInProgress=true},afterNavigate:function(){t._bNavigationInProgress=false;if(t._bOkPressedDuringNavigate){t._bOkPressedDuringNavigate=false;t._pressDialogOk()}},pages:[new sap.m.Page(this.getId()+"-filter",{enableScrolling:true,title:this._bundle.getText("FACETFILTER_TITLE"),subHeader:new sap.m.Bar({contentMiddle:f}),content:[this._facetList]}),new sap.m.Page(this.getId()+"-item",{showNavButton:true,enableScrolling:true,subHeader:new sap.m.Bar({contentMiddle:this._itemsSearchField}),content:[this._cbSelectAll,this._itemsList],navButtonPress:function(e){t._pressDialogNavBack(e)}})]});this._dialog=new sap.m.Dialog(this.getId()+"-dialog",{showHeader:false,content:this._navcon,stretchOnPhone:true,afterClose:function(){t._updateSummaryBar()},beginButton:new sap.m.Button(this.getId()+"-dialog-okbtn",{text:this._bundle.getText("FACETFILTER_ACCEPT"),press:function(){t._pressDialogOk()}}),contentHeight:"500px"});var l=this.getProperty("liveSearch");this.setLiveSearch(l)};
sap.m.FacetFilter.prototype._setItemsFilter=function(v){var b=this._itemsList.getBinding("items");var p=this._itemsList.getBindingInfo("items").template.getBindingInfo("title").parts[0].path;if(b&&p){var f=new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.Contains,v);b.filter([f]);this._setCBSelectAll()}};
sap.m.FacetFilter.prototype.onAfterRendering=function(){if(!jQuery.device.is.phone){var h=jQuery.sap.domById(this.getId()+"-head");var $=this.$();sap.ui.getCore().attachIntervalTimer(jQuery.proxy(this._checkOverflow,this,h,$),this)}};
sap.m.FacetFilter.prototype.openFilterDialog=function(){this._displayFacetDialog()};
sap.m.FacetFilter.prototype._pressDialogNavBack=function(e){this._applyDialogSelection();this._facetList.setSelectedItem(this._facetList.getSelectedItem(),false);this._navcon.back(this.getId()+"-filter");var i=sap.ui.getCore().byId(this.getId()+"-itemsSearchField");i.setValue()};
sap.m.FacetFilter.prototype._applyDialogSelection=function(){if(this._navcon.getCurrentPage().getId()===this.getId()+"-item"){var f=this.getLists()[this._currentFacetIndex];var m=f._modelName;var F=f.getItems();var l=this._itemsList.getItems();var s=false;if(f.getMultiSelect()){s=this._cbSelectAll.getSelected()}jQuery.each(l,function(a,v){if(!v.getBindingInfo("selected")){for(var i=a;i<F.length;i++){if(v.getBindingContext(m)&&v.getBindingContext(m).getPath()){var p=v.getBindingContext(m).getPath();if(F[i].getBindingContext(m)&&F[i].getBindingContext(m).getPath()===p){s=s||v.getSelected();F[i].setSelected(v.getSelected());break}}}}});if(!s){for(var i=0;i<F.length;i++){s=F[i].getSelected();if(s){break}}}if(s){f.setActive(true);f._fireListCloseEvent()}}};
sap.m.FacetFilter.prototype._pressDialogOk=function(e){if(this._bNavigationInProgress){this._bOkPressedDuringNavigate=true;return}this._applyDialogSelection();this._dialog.close();sap.ui.getCore().byId(this.getId()+"-facetsSearchField").setValue();sap.ui.getCore().byId(this.getId()+"-itemsSearchField").setValue()};
sap.m.FacetFilter.prototype._copySelectionToItemsList=function(){var l=this._itemsList.getItems();var f=this.getLists()[this._currentFacetIndex];var F=f.getItems();var m=f._modelName;var a=0;jQuery.each(F,function(b,v){if(!v.getBindingInfo("selected")){for(var i=a;i<l.length;i++){if(v.getBindingContext(m)&&v.getBindingContext(m).getPath()){var p=v.getBindingContext(m).getPath();if(l[i].getBindingContext(m)&&l[i].getBindingContext(m).getPath()===p){l[i].setSelected(v.getSelected());a=i;break}}}}})};
sap.m.FacetFilter.prototype._deselectAll=function(e){var f=this.getLists()[this._currentFacetIndex].getItems();jQuery.each(f,function(i,v){v.setProperty("selected",false,true)})};
sap.m.FacetFilter.prototype._handleSelectionChange=function(e){var v=e.getParameters().listItems;var f=this.getLists()[this._currentFacetIndex];var F=f.getItems();var m=f._modelName;jQuery.each(v,function(a,b){if(b&&!b.getBindingInfo("selected")){var p=b.getBindingContext(m).getPath();var s=!f.getMultiSelect();var c=false;for(var i=0;i<F.length;i++){if(!c&&F[i].getBindingContext(m).getPath()===p){F[i].setProperty("selected",e.getParameters().selected,true);c=true}else if(s){F[i].setProperty("selected",false,true)}}}});this._setCBSelectAll()};
sap.m.FacetFilter.prototype._updateFinished=function(e){this._copySelectionToItemsList()};
sap.m.FacetFilter.prototype._selectFacet=function(e){var l=e.getParameter("listItem");this._currentFacetIndex=this._getIndex(l);var i=this._currentFacetIndex;var f=this.getLists()[i];var F=this;F._itemsList.setGrowing(f.getGrowing());F._itemsList.setGrowingThreshold(f.getGrowingThreshold());F._itemsList.setGrowingTriggerText(f.getGrowingTriggerText());f._modelSync=function(m){F._itemsList.setModel(m);F._itemsList.setBindingContext(this._list.getBindingContext());var L={path:this._list.getBindingInfo("items").path,template:this._list.getBindingInfo("items").template};F._itemsList.bindAggregation("items",L);var a=this;F._copySelectionToItemsList();F._itemsList._ffList=a;F._setCBSelectAll()};f.fireListOpen({});this._navcon.getPages()[1].setTitle(f.getTitle());this._cbSelectAll.setVisible(f.getMultiSelect());this._itemsList.setMode(f.getMultiSelect()?sap.m.ListMode.MultiSelect:sap.m.ListMode.SingleSelectMaster);var o=f._list.getBindingContext()&&f._list.getBindingContext().getModel()||f._list.getModel();if(o){this._itemsList.setModel(o);this._itemsList.setBindingContext(f._list.getBindingContext());var L={path:f._list.getBindingInfo("items").path,template:f._list.getBindingInfo("items").template};this._itemsList.bindAggregation("items",L);this._copySelectionToItemsList();this._itemsList._ffList=f;this._setCBSelectAll()}else{if(this._itemsList._ffList&&(this._itemsList._ffList!=f)){this._itemsList.setModel(new sap.ui.model.json.JSONModel())}}this._navcon.to(this.getId()+"-item")};
sap.m.FacetFilter._getFacetIndex=function(l,a){var b=l.getItems();for(var i=0;i<b.length;i++){if(b[i].getId()===a.getId()){return i}}return-1};
sap.m.FacetFilter.prototype._displayFacetDialog=function(e){this._aFacetFilterLists=[];for(var i=0;i<this.getLists().length;i++){var l=this.getLists()[i];this._aFacetFilterLists.push({text:l.getTitle(),count:l.getAllCount(),index:i})}var j=new sap.ui.model.json.JSONModel({items:this._aFacetFilterLists});this._facetList.setModel(j);this._dialog.open();this._navcon.backToTop()};
sap.m.FacetFilter.prototype.exit=function(){if(!jQuery.device.is.phone){sap.ui.getCore().detachIntervalTimer(this._checkOverflow,this)}if(this._facetAddIcon){this._facetAddIcon.destroy();this._facetAddIcon=undefined}if(this._summaryBar){this._summaryBar.destroy();this._summaryBar=undefined}if(this._oArrowLeft){this._oArrowLeft.destroy();this._oArrowLeft=undefined}if(this._oArrowRight){this._oArrowRight.destroy();this._oArrowRight=undefined}if(this._dialog){this._dialog.destroy();this._dialog=undefined}};
sap.m.FacetFilter.prototype.getSummaryText=function(){var C=", ";var S=" ";var f="";var F=true;var l=this.getLists();if(l&&l.length>0){for(var i=0;i<l.length;i++){var o=l[i];if(o.getActive()){var L=o.getSelectedItems();var t="";for(var j=0;j<L.length;j++){t=t+L[j].getText()+C}if(t){t=t.substring(0,t.lastIndexOf(C)).trim();if(F){f=this._bundle.getText("FACETFILTER_INFOBAR_FILTERED_BY",[o.getTitle(),t]);F=false}else{f=f+S+this._bundle.getText("FACETFILTER_INFOBAR_AND")+S+this._bundle.getText("FACETFILTER_INFOBAR_AFTER_AND",[o.getTitle(),t])}}}}}if(!f){f=this._bundle.getText("FACETFILTER_INFOBAR_NO_FILTERS")}if(!f){f=this._bundle.getText("FACETFILTER_INFOBAR_NO_FILTERS")}return f};
sap.m.FacetFilter.prototype._handleSummaryBarPress=function(e){if(this._bOpenDialogInLiteFlow){this.openFilterDialog()}this._bOpenDialogInLiteFlow=true};
sap.m.FacetFilter.prototype._getScrollingArrow=function(n){var p={src:"sap-icon://navigation-"+n+"-arrow"};var c=["sapMPointer","sapMFFArrowScroll","sapMFFArrowScrollLeft"];var C=["sapMPointer","sapMFFArrowScroll","sapMFFArrowScrollRight"];if(n==="left"){if(!this._oArrowLeft){this._oArrowLeft=sap.m.ImageHelper.getImageControl(this.getId()+"-arrowScrollLeft",this._oArrowLeft,this,p,c)}return this._oArrowLeft}if(n==="right"){if(!this._oArrowRight){this._oArrowRight=sap.m.ImageHelper.getImageControl(this.getId()+"-arrowScrollRight",this._oArrowRight,this,p,C)}return this._oArrowRight}};
sap.m.FacetFilter.prototype._checkScrolling=function(h,$){var s=false;if(h){if(h.scrollWidth>h.clientWidth){s=true}}$.toggleClass("sapMFFScrolling",s);$.toggleClass("sapMFFNoScrolling",!s);this._lastScrolling=s};
sap.m.FacetFilter.prototype._checkOverflow=function(b,$){this._checkScrolling(b,$);if(b){var s=b.scrollLeft;var S=false;var a=false;var r=b.scrollWidth;var c=b.clientWidth;if(Math.abs(r-c)==1){r=c}if(!this._bRtl){if(s>0){S=true}if((r>c)&&(s+c<r)){a=true}}else{var l=jQuery(b);if(l.scrollLeftRTL()>0){a=true}if(l.scrollRightRTL()>0){S=true}}if((a!=this._bPreviousScrollForward)||(S!=this._bPreviousScrollBack)){this._bPreviousScrollForward=a;this._bPreviousScrollBack=S;$.toggleClass("sapMFFNoScrollBack",!S);$.toggleClass("sapMFFNoScrollForward",!a)}}};
sap.m.FacetFilter.prototype.onclick=function(e){this._handleActivation(e)};
sap.m.FacetFilter.prototype._handleActivation=function(e){var t=e.target.id;if(t){var i=this.getId();e.preventDefault();if(t==i+"-arrowScrollLeft"){this._scroll(-sap.m.FacetFilter.SCROLL_STEP,500)}else if(t==i+"-arrowScrollRight"){this._scroll(sap.m.FacetFilter.SCROLL_STEP,500)}}};
sap.m.FacetFilter.prototype._scroll=function(d,D){var o=jQuery.sap.domById(this.getId()+"-head");var s=o.scrollLeft;if(!!!sap.ui.Device.browser.internet_explorer&&this._bRtl){d=-d}var S=s+d;jQuery(o).stop(true,true).animate({scrollLeft:S},D)};
sap.m.FacetFilter.prototype._handleResetPress=function(e){this.fireReset();var f=this.getLists();for(var i=0;i<f.length;i++){f[i]._getFacetButton().setText(f[i]._getSelectionText())}this._bOpenDialogInLiteFlow=true;if(this._getShowSummaryBar()&&this._summaryBar.getActive()){this._bOpenDialogInLiteFlow=false}};
sap.m.FacetFilter.prototype._getType=function(){if(jQuery.device.is.phone){return sap.m.FacetFilterType.Light}else{return this.getType()}};
sap.m.FacetFilter.prototype._updateSummaryBar=function(){this._summaryBar.getContent()[0].setText(this.getSummaryText())};
sap.m.FacetFilter.prototype._getShowSummaryBar=function(){if(this._getType()===sap.m.FacetFilterType.Light){return true}else{return this.getShowSummaryBar()}};
sap.m.FacetFilter.prototype._getIndex=function(l){var c=l.getCustomData();for(var i=0;i<c.length;i++){if(c[i].getKey()==="index"){return c[i].getValue()}}};
sap.m.FacetFilter.prototype._getSelectedItems=function(){var f=this._aFacetFilterLists[this._currentFacetIndex].aItems;var s=[];for(var i=0;i<f.length;i++){if(f[i].selected){s.push(f[i])}}return s};
sap.m.FacetFilter.prototype._enableTouchSupport=function(){var t=this;var T=function(e){e.preventDefault();if(t._iInertiaIntervalId){window.clearInterval(t._iInertiaIntervalId)}t.startScrollX=jQuery.sap.domById(t.getId()+"-head").scrollLeft;t.startTouchX=e.touches[0].pageX;t._bTouchNotMoved=true;t._lastMoveTime=new Date().getTime()};var f=function(e){var d=e.touches[0].pageX-t.startTouchX;var l=jQuery.sap.domById(t.getId()+"-head");var o=l.scrollLeft;var n=t.startScrollX-d;l.scrollLeft=n;t._bTouchNotMoved=false;var b=new Date().getTime()-t._lastMoveTime;t._lastMoveTime=new Date().getTime();if(b>0){t._velocity=(n-o)/b}e.preventDefault()};var a=function(e){if(t._bTouchNotMoved===false){e.preventDefault();var l=jQuery.sap.domById(t.getId()+"-head");var d=50;var b=Math.abs(t._velocity/10);t._iInertiaIntervalId=window.setInterval(function(){t._velocity=t._velocity*0.80;var c=t._velocity*d;l.scrollLeft=l.scrollLeft+c;if(Math.abs(t._velocity)<b){window.clearInterval(t._iInertiaIntervalId);t._iInertiaIntervalId=undefined}},d)}else if(t._bTouchNotMoved===true){t.onclick(e);e.preventDefault()}else{}t._bTouchNotMoved=undefined;t._lastMoveTime=undefined};this.ontouchstart=T;this.ontouchend=a;this.ontouchmove=f};
sap.m.FacetFilter.prototype.addList=function(f){this.addAggregation("lists",f);f._setLiveSearch(this.getLiveSearch())};
sap.m.FacetFilter.prototype.insertList=function(f,i){this.insertAggregation("lists",f,i);f._setLiveSearch(this.getLiveSearch())};
sap.m.FacetFilter.prototype._setCBSelectAll=function(){var l=this.getLists()[this._currentFacetIndex];if(l.getMultiSelect()){this._cbSelectAll.setSelected(l.getSelectedItems().length===0&&l.getActive())}};
sap.m.FacetFilter.prototype._handleItemsListLiveChange=function(e){this._setItemsFilter(this._itemsSearchField.getValue())};
sap.m.FacetFilter.prototype.setLiveSearch=function(l){this.setProperty("liveSearch",l,true);if(l){this._itemsSearchField.attachLiveChange(this._handleItemsListLiveChange,this)}else{this._itemsSearchField.detachLiveChange(this._handleItemsListLiveChange,this)}var L=this.getLists();for(var i=0;i<L.length;i++){L[i]._setLiveSearch(l)}};
