"use strict";jQuery.sap.require('sap.portal.ui5.core.View');jQuery.sap.declare('sap.portal.ui5.core.UI5ControlView');sap.portal.ui5.core.View.extend('sap.portal.ui5.core.UI5ControlView',{metadata:{properties:{config:{type:'any',defaultValue:{}},controlClass:{type:'string',defaultValue:null},control:{type:'any',defaultValue:null},layoutControl:{type:'any',defaultValue:null},layoutClass:{type:'string',defaultValue:null},layoutConfig:{type:'any',defaultValue:{}},controlStyleClass:{type:'any',defaultValue:null},layoutStyleClass:{type:'any',defaultValue:null},width:{type:'string',defaultValue:null},height:{type:'string',defaultValue:null},innerWidth:{type:'string',defaultValue:null},innerHeight:{type:'string',defaultValue:null},minWidth:{type:'string',defaultValue:null},minHeight:{type:'string',defaultValue:null},maxWidth:{type:'string',defaultValue:null},maxHeight:{type:'string',defaultValue:null}},events:{innerReflow:{}}},renderPromise:null,unrenderPromise:null,renderChildComponentsPromise:null,processDimensionsPromise:null,processInnerDimensionsPromise:null,processConfig:function processConfig(c){return c},processLayoutConfig:function processLayoutConfig(c){return c},instantiateLayoutControl:sap.portal.ui5.core.PropertyObserver('layoutConfig',function instantiateLayoutControl(){var c=this.getLayoutConfig(),C=this.getLayoutControl();if(c===null||C){return}var i='sap.ui.core.Control',s=this.getProperty('layoutClass');if(!s){return}c=this.processLayoutConfig(c);C=sap.portal.ui5.core.Object.factoryObject(c||{},i,s);this.setLayoutControl(C)}).callOnInit(),invalidateControl:function invalidateControl(c,r){var p=sap.portal.ui5.core.UI5ControlView.aPendingInvalidationControls;if(p.indexOf(c)===-1&&!c.isInvalidateSuppressed()){p.push(c);if(r){}return c.invalidate()}},instantiateControl:sap.portal.ui5.core.PropertyObserver('config',function instantiateControl(){var c=this.getConfig(),C=this.getControl();if(c===null||C){return}var i='sap.ui.core.Control',s=this.getProperty('controlClass');if(!s){return}c=this.processConfig(c);C=sap.portal.ui5.core.Object.factoryObject(c||{},i,s);this.setControl(C)}).callOnInit(),attachLayoutControl:sap.portal.ui5.core.PropertyObserver(['control','layoutControl'],function attachLayoutControl(){var c=this.getControl(),l=this.getLayoutControl();if(!c||!l){return}l.placeAt(c);if(typeof(c.insertContent)!=='function'){throw new Error('Control does not support inner content/inner layout')}}),processComponentModel:sap.portal.ui5.core.PropertyObserver(['control','componentModel'],function processComponentModel(){var c=this.getControl(),m=this.getComponentModel();if(m instanceof sap.ui.model.Model&&c instanceof sap.ui.core.Element){c.setModel(m)}}).callOnInit(),destroyControl:function destroyControl(){var c=this.getControl();if(c){c.destroy(this.isRendered()?false:true)}this.setControl(null)},destroyLayoutControl:function destroyLayoutControl(){var c=this.getLayoutControl();if(c){c.destroy()}this.setLayoutControl(null)},destroy:function destroy(){var p=[],s=this._super.bind(this,arguments),i=this.getId(),d=jQuery.Deferred();d.bInUse=true;d.sUid='destroy-'+jQuery.sap.uid();p.push(this.unrender());p.push(this.destroyLayoutControl());p.push(this.destroyControl());jQuery.when.apply(jQuery,p).always(function(){jQuery.when(s()).always(function(){d.resolve()})});return d.promise()},unrender:function unrender(){var i=this.getId(),r=this.renderPromise,R=this.renderChildComponentsPromise;this.fireEvent('beforeUnrender');if(r&&r.bInUse&&r.state()==='pending'){r.reject()}if(R&&R.bInUse&&R.state()==='pending'){R.reject()}this.renderPromise=null;this.renderChildComponentsPromise=null;var d=this.unrenderPromise=jQuery.Deferred();d.bInUse=true;d.sUid='unrender-'+jQuery.sap.uid();d.done(function fireEvent(){this.fireEvent('unrender')}.bind(this));try{var c=this.getControl();switch(true){case(c===null||typeof(c)==='undefined'):d.resolve(false);break;case(c instanceof sap.ui.core.Element):var u=c.getUIArea(),p=c.getParent();switch(true){case(u&&u.indexOfContent(c)!==-1):sap.portal.ui5.core.UI5ControlView.aPendingUIUpdatedPromises.push(d);u.removeContent(c);break;case(p&&typeof(p.removeContent)==='function'):p.removeContent(c);if(p.isInvalidateSuppressed()){c.$().remove();d.resolve()}else{sap.portal.ui5.core.UI5ControlView.aPendingUIUpdatedPromises.push(d)}break;default:c.$().remove();d.resolve();break}break;default:throw new Error('Unsupported')}}catch(e){d.rejectWith(this,e);throw e}return d.promise()},render:function render(){var d=this.renderPromise,p=this.getPlaceAt(),i=this.getId(),u=this.unrenderPromise;if(u&&u.bInUse&&u.state()==='pending'){u.reject()}this.unrenderPromise=null;var c={placeAt:p};if(d&&d.bInUse){if(jQuery.sap.equal(c,d.oConfig)&&d.state()!=='rejected'){return d}switch(d.state()){case'pending':d.reject();d=jQuery.Deferred();break;default:d=jQuery.Deferred();break}}else if(!d){d=jQuery.Deferred()}this.renderPromise=d;d.sUid='render-'+jQuery.sap.uid();d.bInUse=true;d.oConfig=c;d.oPromise=d.promise();d.oPromise.oDeferred=d;if(this.isDestroyed()){d.reject();return d.oPromise}d.done(function fireEvent(){this.fireEvent('render')}.bind(this));var I=false,C=sap.ui.getCore();try{var o=this.getControl();if(!o){d.reject();return d.oPromise}var P=(jQuery.isPlainObject(p))?p.target:p;if(typeof(p)==='object'){var a=['width','minWidth','maxWidth','height','minHeight','maxHeight','innerWidth','innerHeight'];var b,e=a.length,s,m;for(b=0;b<e;b++){s=a[b];if(typeof(p[s])!=='undefined'&&String(this.mProperties[s])!==String(p[s])){o.iSuppressInvalidate++;m=s+' is changed from '+this.mProperties[s]+' to '+p[s];this.setProperty(s,p[s]);o.iSuppressInvalidate--;if(!jQuery.when(this.processDimensionsPromise).isResolved()||!jQuery.when(this.processInnerDimensionsPromise).isResolved()){I=typeof(I)==='string'?(I+', '+m):(m)}}}}switch(true){case P instanceof sap.ui.commons.layout.PositionContainer:if(o.getParent()!==P){I=P.getParent()?false:true;P.iSuppressInvalidate++;P.setControl(o);P.iSuppressInvalidate--;if(!this.isRendered()){I='Position container got a new control'}}break;case P instanceof sap.ui.core.Element:if(typeof(P.insertContent)==='function'){var A=P.indexOfContent(o);switch(true){case(typeof(p.index)!=='undefined')&&(A!==p.index):if(A!==-1){o.iSuppressInvalidate++;P.removeContent(o);o.iSuppressInvalidate--}o.iSuppressInvalidate++;P.insertContent(o,p.index);o.iSuppressInvalidate--;I='Content inserterted into control at specific position';break;case A===-1:o.iSuppressInvalidate++;P.insertContent(o);o.iSuppressInvalidate--;I='Content inserted into control';break}}else{o.iSuppressInvalidate++;o.placeAt(P);o.iSuppressInvalidate--;I='Control got a new placeholder'}break;case typeof(P)==='string':case P instanceof jQuery:o.iSuppressInvalidate++;o.placeAt(P);o.iSuppressInvalidate--;I='Control got a new jQuery placeholder';break;case P instanceof sap.portal.ui5.core.UI5ControlView:o.iSuppressInvalidate++;o.placeAt(P.getControl());o.iSuppressInvalidate--;I='Control got a new UI5 control placeholder';break;default:throw new Error('Unsupported placeholder')}if(I){d.sInvalidateReason=I;sap.portal.ui5.core.UI5ControlView.aPendingUIUpdatedPromises.push(d);this.invalidateControl(o,I)}else{d.resolve(false)}}catch(E){d.rejectWith(this,E);throw E}return d.oPromise},renderChildComponents:function renderChildComponents(c,C,o){var d=this.renderChildComponentsPromise,i=this.getId(),a=this.getControl(),b=this.getControl().$(),e=this.getChildComponentsControl(),f;switch(true){case(c instanceof sap.portal.ui5.core.ComponentCollection):f=c.getItems();break;case(jQuery.isArray(c)):f=c;break;default:throw new TypeError('Child components is wrong')}var g={childComponents:f,childLayoutData:C,componentLayoutData:o,control:a,childsControl:e};if(d&&d.bInUse){if(jQuery.sap.equal(g,d.oConfig)&&d.state()!=='rejected'){return d.oPromise}switch(d.state()){case'pending':d.reject();d=jQuery.Deferred();break;default:d=jQuery.Deferred();break}}else if(!d){d=jQuery.Deferred()}this.renderChildComponentsPromise=d;d.sUid='render-child-components-'+jQuery.sap.uid();d.bInUse=true;d.oConfig=g;d.oPromise=d.promise();d.oPromise.oDeferred=d;d.oDependencies={childPromises:[],preprocessPromises:[],renderChildComponentEventSubscribers:[]};if(!o&&!f.length){d.resolve();return d.oPromise}if(this.isDestroyed()||!e){d.reject();return d.oPromise}if(o){if(o.animation){var A=jQuery.Deferred(),h={},r=false;jQuery.each(['top','left','right','bottom'],function(j,p){if(typeof(o[p])!=='undefined'){var v=b.css(p);if(typeof(o[p])==='number'){o[p]=String(o[p])+'px'}if(o[p]!==v){h[p]=o[p]}}});jQuery.each(['width','height','minWidth','minHeight','maxWidth','maxHeight'],function(j,p){if(typeof(o[p])!=='undefined'){var s=b.css(p),v=o[p];if(typeof(v)==='number'){v=String(v)+'px'}if(v!==s){h[p]=v;r=true}}});if(jQuery.sap.equal(h,{})){A.resolve()}else{b.stop(true,true).animate(h,jQuery.extend({complete:function onAnimationComplete(){if(r&&this.hasListeners('reflow')){this.fireEvent('reflow',{reason:'Animation completed: '+JSON.stringify(h)})}A.resolve()}.bind(this)},o.animation))}d.oDependencies.preprocessPromises.push(A)}else{b.css({top:o.top,left:o.left,right:o.right,bottom:o.bottom});jQuery.each(['width','minWidth','maxWidth','height','minHeight','maxHeight'],function(j,p){if(typeof(o[p])!=='undefined'){this.setProperty(p,o[p])}}.bind(this))}}var I=!e.getContent().length;if(I){e.iSuppressInvalidate++}jQuery.each(f,function renderChildComponent(j,k){if(k.isDestroyed()){return}var s=k.getComponentId();var l=C?C[s]||{}:{};var p=jQuery.extend({},l,{target:e,index:(typeof(l.index)!=='undefined'?l.index:j)});switch(true){case(e instanceof sap.ui.commons.layout.AbsoluteLayout):var m=e.getPositions(),n=k.getPlaceAt(),P={top:typeof(l.top)==='number'?l.top+'px':l.top,left:typeof(l.left)==='number'?l.left+'px':l.left,right:typeof(l.right)==='number'?l.right+'px':l.right,bottom:typeof(l.bottom)==='number'?l.bottom+'px':l.bottom},q,t,u;if(jQuery.sap.equal(P,{})){return}if(jQuery.isPlainObject(n)&&n.target){n=n.target}u=m.indexOf(n);if(u!==-1){q=m[u];t=q.$();var U=function updatePositions(F){var z=q.mProperties;jQuery.each(['top','left','right','bottom'],function(j,B){switch(true){case F:case(z[B]||P[B])&&(z[B]!==P[B]):e.iSuppressInvalidate++;q.setProperty(B,P[B]);e.iSuppressInvalidate--;break}});if(F){t.css(P)}};var v=l.animation||false,w={};if(v){var A=jQuery.Deferred(),x=t.queue();if(x&&x.length){t.stop(true,true)}w.complete=function onAnimationComplete(){if(l.force){t.css(P)}U(l.force);switch(d.state()){case'rejected':A.reject();break;default:A.resolve();break}};if(t.length){t.stop(true,true).animate(P,jQuery.extend(w,v))}else{w.complete()}d.oDependencies.preprocessPromises.push(A.promise())}else{U(l.force);this.invalidateControl(q,'Updated positions: '+JSON.stringify(P))}}else{q=new sap.ui.commons.layout.PositionContainer({top:typeof(l.top)==='number'?l.top+'px':l.top,left:typeof(l.left)==='number'?l.left+'px':l.left,right:typeof(l.right)==='number'?l.right+'px':l.right,bottom:typeof(l.bottom)==='number'?l.top+'px':l.bottom})}p.target=q;break}k.attachEvent('beforeUnrender',{},function onBeforeUnrender(E){var L=this.getChildComponentsControl();if(!L){return}var R=function releaseSuspend(){L.iSuppressInvalidate--}.bind(this);k.attachEvent('unrender',{},R);L.iSuppressInvalidate++}.bind(this));var y=k.setPlaceAt(p);if(u===-1){e.addPosition(q);sap.portal.ui5.core.UI5ControlView.resolvePendingUIUpdatedPromises()}d.oDependencies.childPromises.push(y)}.bind(this));jQuery.when.apply(jQuery,d.oDependencies.preprocessPromises).always(function releaseSupress(){if(I){e.iSuppressInvalidate--}}).pipe(function onAfterPreprocess(){if(I){this.invalidateControl(e)}return d.oDependencies.childPromises}.bind(this)).pipe(function onAfterRerendering(){this.fireEvent('renderChildComponents',{view:this,promises:d.oDependencies.renderChildComponentEventSubscribers,childComponents:c,childLayout:C,componentLayout:o});return jQuery.when.apply(jQuery,d.oDependencies.renderChildComponentEventSubscribers)}.bind(this)).then(function(){var j=sap.ui.getCore();if(I){sap.portal.ui5.core.UI5ControlView.aPendingUIUpdatedPromises.push(d)}else{d.resolve()}});return d.oPromise},getChildComponentsControl:function getChildComponentsControl(){return this.getLayoutControl()||this.getControl()},isRendered:function isRendered(){var c=this.getLayoutControl()||this.getControl();if(!c){return false}return Boolean(c.$().length)},getWidth:function getWidth(u){return this.getSizeProperty('width','',u)},getInnerWidth:function getInnerWidth(u){return this.getSizeProperty('width','inner',u)},getHeight:function getHeight(u){return this.getSizeProperty('height','',u)},getInnerHeight:function getInnerHeight(u){return this.getSizeProperty('height','inner',u)},getSizeProperty:function getSizeProperty(p,c,u){var v,C,u=u?String(u).toLowerCase():'',c=c||'';switch(c){case'inner':C=this.getLayoutControl()||this.getControl();break;default:C=this.getControl();break}if(C){var a=C.mProperties[p];if(a&&u&&typeof(a)==='string'&&a.indexOf(u)!==-1){v=a}else{var s=c.toLowerCase()+(c?p.charAt(0).toUpperCase()+p.substr(1):p);var U='get'+s.charAt(0).toUpperCase()+s.substr(1);var d=C.$();if(this.getLayoutControl()){d=C.$().parent()}if(typeof(d[s])==='function'){v=d[s]()}else if(typeof(C[U])==='function'){v=C[U]()}else{throw new Error('Unsupported property')}}}switch(true){case(v===null||typeof(v)==='undefined'):v='0'+u;break;case(u&&typeof(v)==='string'&&v.indexOf(u)!==-1):break;case Boolean(u):v=String(v)+u;break}return v},processControlStyleClass:sap.portal.ui5.core.PropertyObserver(['controlStyleClass','control'],function processControlStyleClass(k,n,o){var c=this.getControl();if(!c){return}var s=this.getControlStyleClass();if(jQuery.isArray(s)){s=s.join(' ')}if(!s){return}if(k==='controlStyleClass'&&o){c.removeStyleClass(o)}c.addStyleClass(s)}),processLayoutStyleClass:sap.portal.ui5.core.PropertyObserver(['layoutStyleClass','layoutControl'],function processLayoutControlStyleClass(k,n,o){var c=this.getLayoutControl();if(!c){return}var s=this.getLayoutStyleClass();if(jQuery.isArray(s)){s=s.join(' ')}if(!s){return}if(k==='layoutStyleClass'&&o){c.removeStyleClass(o)}c.addStyleClass(s)}),processDimensions:sap.portal.ui5.core.PropertyObserver(['width','height','minWidth','minHeight','maxWidth','maxHeight','control'],function processDimensions(k,v){var c=this.getControl();if(!c){return}var i=this.getId(),w=this.getProperty('width'),h=this.getProperty('height'),d=c.$(),D=this.processDimensionsPromise,I=false,r=false;if(D&&D.bInUse){switch(D.state()){case'pending':D.reject();D=jQuery.Deferred();break;default:D=jQuery.Deferred();break}}else if(!D){D=jQuery.Deferred()}this.processDimensionsPromise=D;D.sUid='process-dimensions-'+jQuery.sap.uid();D.bInUse=true;D.oPromise=D.promise();D.oPromise.oDeferred=D;c.iSuppressInvalidate++;if(w!==''&&!isNaN(w)){w=w+'px'}if(w!==''&&c.getWidth()!==w){r='Width updated from '+c.getWidth()+' to '+w;if(d.length){d.width(w);c.mProperties.width=w}else{I=true;c.setWidth(w)}}if(h!==''&&!isNaN(h)){h=h+'px'}if(h!==''&&c.getHeight()!==h){r='Height updated from '+c.getHeight()+' to '+h;if(d.length){d.height(h);c.mProperties.height=h}else{I=true;c.setHeight(h)}}if(d.length){var m=this.getProperty('minWidth'),M=this.getProperty('maxWidth'),s=this.getProperty('minHeight'),a=this.getProperty('maxHeight');if(m!==''&&!isNaN(m)){m=m+'px'}if(M!==''&&!isNaN(M)){M=M+'px'}if(s!==''&&!isNaN(s)){s=s+'px'}if(a!==''&&!isNaN(a)){a=a+'px'}d.css({minWidth:m,maxWidth:M,minHeight:s,maxHeight:a})}c.iSuppressInvalidate--;D.sReason=r;if(I){if(r){var n=function notify(){sap.ui.getCore().detachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n);D.resolve();if(this.hasListeners('reflow')){}this.fireEvent('reflow',{reason:r})}.bind(this);if(!c.iSuppressInvalidate){D.fail(function(){sap.ui.getCore().detachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n)});sap.ui.getCore().attachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n)}}this.invalidateControl(c,r)}else if(r){D.resolve();if(this.hasListeners('reflow')){}this.fireEvent('reflow',{reason:r})}else{D.resolve()}}),processInnerDimensions:sap.portal.ui5.core.PropertyObserver(['innerWidth','innerHeight','control','layoutControl'],function processInnerDimensions(k,v){var c=this.getChildComponentsControl();if(!c){return}var i=this.getId(),w=this.getProperty('innerWidth'),h=this.getProperty('innerHeight'),d=c.$(),D=this.processInnerDimensionsPromise,I=false,r=false;if(D&&D.bInUse){switch(D.state()){case'pending':D.reject();D=jQuery.Deferred();break;default:D=jQuery.Deferred();break}}else if(!D){D=jQuery.Deferred()}this.processInnerDimensionsPromise=D;D.sUid='process-inner-dimensions-'+jQuery.sap.uid();D.bInUse=true;D.oPromise=D.promise();D.oPromise.oDeferred=D;c.iSuppressInvalidate++;if(w!==''&&c.getWidth()!==w){if(!isNaN(w)){w=w+'px'}r='Inner width updated from '+c.getWidth()+' to '+w;if(d.length){d.width(w);c.mProperties.width=w}else{I=true;c.setWidth(w)}}if(h!==''&&c.getHeight()!==h){if(!isNaN(h)){h=h+'px'}r='Inner height updated from '+c.getHeight()+' to '+h;if(d.length){d.height(h);c.mProperties.height=h}else{I=true;c.setHeight(h)}}c.iSuppressInvalidate--;if(I){if(r){var n=function notify(){sap.ui.getCore().detachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n);D.resolve();this.fireEvent('innerReflow',{reason:r})}.bind(this);D.fail(function(){sap.ui.getCore().detachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n)});sap.ui.getCore().attachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n)}this.invalidateControl(c,r)}else if(r){D.resolve();this.fireEvent('innerReflow',{reason:r})}else{D.resolve()}}),getChildComponentPositions:function getChildComponentPositions(c){var C=this.getChildComponentsControl(),p={};switch(true){case(C instanceof sap.ui.commons.layout.AbsoluteLayout):var o=C.getPositions(),a=c.getPlaceAt(),P,i;if(jQuery.isPlainObject(a)&&a.target){a=a.target}i=o.indexOf(a);if(i===-1){break}P=o[i];p.index=o.indexOf(a);p.top=P.getTop();p.left=P.getLeft();p.right=P.getRight();p.bottom=P.getBottom();break;default:p.index=o.indexOf(a);break}return p}});(function(){var n=sap.portal.ui5.core.UI5ControlView;n.aPendingInvalidationControls=[];n.aPendingUIUpdatedPromises=[];n.resolvePendingUIUpdatedPromises=function resolvePendingUIUpdatedPromises(){var p=n.aPendingUIUpdatedPromises;var i,l=p.length;if(!l){return}n.aPendingUIUpdatedPromises=[];n.aPendingInvalidationControls=[];for(i=0;i<l;i++){p[i].resolve()}};sap.ui.getCore().attachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,n.resolvePendingUIUpdatedPromises)}());
