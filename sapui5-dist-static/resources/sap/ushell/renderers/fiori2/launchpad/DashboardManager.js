// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.renderers.fiori2.launchpad.DashboardManager");jQuery.sap.require("sap.ushell.services.Message");jQuery.sap.require('sap.ushell.functionOverrideResizeEvent');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-core');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-widget');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-mouse');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-sortable');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-draggable');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-droppable');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-effects-core');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-effects-shake');var g=function(m){return sap.ushell.resources.i18n.getText(m)};sap.ui.base.EventProvider.extend("sap.ushell.renderers.fiori2.launchpad.DashboardManager",{metadata:{publicMethods:["getModel","getDashboardView","getGroupListView","loadPersonalizedGroups","attachEvent","detachEvent","attachEventOnce"]},constructor:function(i,s){if(sap.ushell.renderers.fiori2.launchpad.getDashboardManager&&sap.ushell.renderers.fiori2.launchpad.getDashboardManager()){return sap.ushell.renderers.fiori2.launchpad.getDashboardManager()}sap.ushell.renderers.fiori2.launchpad.getDashboardManager=jQuery.sap.getter(this.getInterface());this.oPageBuilderService=sap.ushell.Container.getService("LaunchPage");this.oBookmarkService=sap.ushell.Container.getService("Bookmark");this.oModel=s.model;this.oDashboardView=sap.ui.jsview("dashboard","sap.ushell.renderers.fiori2.launchpad.dashboard.DashboardContent");this.oGroupListView=sap.ui.jsview("groupList","sap.ushell.renderers.fiori2.launchpad.group_list.GroupList");this.oSortableDeferred=$.Deferred();this.oSortableDeferred.resolve();this.aRequestQueue=[];this.bRequestRunning=false;this.registerEvents()},registerEvents:function(){var e=sap.ui.getCore().getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("launchpad","createGroup",this._createGroup,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","addTile",this._createTile,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","moveTile",this._moveTile,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("showCatalog",this.loadAllCatalogs,this);this.oDashboardView.addEventDelegate({onBeforeShow:jQuery.proxy(function(a){this.loadPersonalizedGroups()},this),onAfterHide:jQuery.proxy(function(a){this._destroyAllGroupModels("/groups")},this)})},_refreshTiles:function(){var t=this,G=this.oModel.getProperty("/groups");jQuery.each(G,function(n,o){jQuery.each(o.tiles,function(n,T){t.oPageBuilderService.refreshTile(T.object)})})},_sortableStart:function(){this.oSortableDeferred=$.Deferred()},_sortableStop:function(){this.oSortableDeferred.resolve()},_handleAfterSortable:function(f){return $.proxy(function(){var o=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){f.apply(null,o)})},this)},_addRequest:function(r){this.aRequestQueue.push(r);if(!this.bRequestRunning){this.bRequestRunning=true;this.aRequestQueue.shift()()}},_checkRequestQueue:function(){if(this.aRequestQueue.length===0){this.bRequestRunning=false}else{this.aRequestQueue.shift()()}},_requestFailed:function(){this.aRequestQueue=[];this.bRequestRunning=false},_createGroup:function(c,e,d){var t=this,G=this._getGroupModel(null),a=this.oModel.getProperty("/groups"),b=sap.ui.getCore().getEventBus();this.oModel.setProperty("/groups/"+a.length,G);window.setTimeout($.proxy(b.publish,b,"launchpad","scrollToGroup",{groupId:G.groupId}),1)},_getIndexOfGroup:function(G){var n=null,a=this.oModel.getProperty("/groups");jQuery.each(a,function(b,o){if(o.groupId===G){n=b;return false}});return n},_getPathOfGroup:function(G){return"/groups/"+this._getIndexOfGroup(G)},_getPathOfTile:function(t){var G=this.oModel.getProperty("/groups"),n=null,a=null;jQuery.each(G,function(b,o){jQuery.each(o.tiles,function(c,T){if(T.uuid===t){n=b;a=c;return false}});if(n!==null){return false}});return n!==null?"/groups/"+n+"/tiles/"+a:null},_moveInArray:function(a,n,b){if(b>=a.length){var k=b-a.length;while((k--)+1){a.push(undefined)}}a.splice(b,0,a.splice(n,1)[0])},_deleteGroup:function(c,e,d){var t=this,G=d.groupId,a=this.oModel.getProperty("/groups"),n=this._getIndexOfGroup(G),o=null,r;this._destroyGroupModel("/groups"+n);o=a.splice(n,1)[0].object;this.oModel.setProperty("/groups",a);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.removeGroup(o)}catch(b){this._resetGroupsOnFailure("fail_to_delete_group_msg");return}r.done($.proxy(function(){this._showLocalizedMessage("group_deleted_msg");this._checkRequestQueue()},this));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_delete_group_msg")))},this))},_resetGroup:function(c,e,d){var t=this,G=d.groupId,n=this._getIndexOfGroup(G),o=this.oModel.getProperty("/groups/"+n),r;this.oModel.setProperty("/groups/"+n+"/sortable",false);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.resetGroup(o.object)}catch(a){this._resetGroupsOnFailure("fail_to_reset_group_msg");return}r.done(this._handleAfterSortable($.proxy(function(G,o,R){var n=t._getIndexOfGroup(G);this._loadGroup(n,R||o.object);this._showLocalizedMessage("group_reset_msg");this.oModel.setProperty("/groups/"+n+"/sortable",true);this._checkRequestQueue()},this,G,o)));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_reset_group_msg")))},this))},_moveGroup:function(c,e,d){var f=d.fromIndex,t=d.toIndex,G=this.oModel.getProperty("/groups"),o=G[f],s=o.groupId,r;this._moveInArray(G,f,t);this.oModel.setProperty("/groups",G);if(o.isDefaultGroup){that.toggleDefaultGroupVisibility(false)}this._addRequest($.proxy(function(){var o=this.oModel.getProperty(this._getPathOfGroup(s));try{r=this.oPageBuilderService.moveGroup(o.object,t)}catch(a){this._resetGroupsOnFailure("fail_to_move_group_msg");return}r.done($.proxy(this._checkRequestQueue,this));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_group_msg")))},this))},_changeGroupTitle:function(c,e,d){var n=d.newTitle,G=d.groupId,a=this._getIndexOfGroup(G),o=this.oModel.getProperty("/groups/"+a),r;this.oModel.setProperty("/groups/"+a+"/title",n);if(!o.object){this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addGroup(n)}catch(b){this._resetGroupsOnFailure("fail_to_create_group_msg");return}r.done(this._handleAfterSortable($.proxy(function(G,N){var a=this._getIndexOfGroup(G);this._loadGroup(a,N);this._checkRequestQueue()},this,G)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg")))},this))}else{this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.setGroupTitle(o.object,n)}catch(b){this._resetGroupsOnFailure("fail_to_rename_group_msg");return}r.done($.proxy(this._checkRequestQueue,this));r.fail(this._handleAfterSortable($.proxy(function(G,O){var s=this._getPathOfGroup(G);this._showLocalizedError("fail_to_rename_group_msg");this.oModel.setProperty(s+"/title",O);this._requestFailed()},this,G)))},this))}},_createTile:function(c,e,d){var C=d.catalogTileContext,o=d.groupContext,G=this.oModel.getProperty(o.getPath()).groupId,r;if(o.getObject().isDefaultGroup){this.toggleDefaultGroupVisibility(true)}jQuery.sap.log.debug("Add catalog tile to dashboard",d,this);if(!C){jQuery.sap.log.warning("DashboardManager: Did not receive catalog tile object. Abort.",this);return}this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addTile(C.getProperty("src"),o.getProperty("object"))}catch(a){this._resetGroupsOnFailure("fail_to_add_tile_msg");return}r.done(this._handleAfterSortable($.proxy(function(G,t){var s=this._getPathOfGroup(G);this._addTileToGroup(s,t);this._checkRequestQueue()},this,G))).done($.proxy(C.getModel().setProperty,C.getModel(),"active",true,C)).fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_add_tile_msg")))},this))},_createBookmark:function(c,e,d){this._addRequest($.proxy(function(){var r=this.oBookmarkService.addBookmark(d);r.done($.proxy(this._checkRequestQueue,this));r.fail(this._resetGroupsOnFailureHelper("fail_to_add_tile_msg"))},this))},_deleteTile:function(c,e,d){var t=this,T=d.tileId,G=this.oModel.getProperty("/groups");jQuery.each(G,function(n,o){var f=false;jQuery.each(o.tiles,function(a,b){if(b.uuid===T){t._destroyTileModel("/groups/"+n+"/tiles/"+a);var h=o.tiles.splice(a,1)[0],r;t.oModel.setProperty("/groups/"+n+"/tiles",o.tiles);if(o.isDefaultGroup&&o.tiles.length==0){t.toggleDefaultGroupVisibility(false)}t._addRequest(function(){try{r=t.oPageBuilderService.removeTile(o.object,h.object)}catch(i){this._resetGroupsOnFailure("fail_to_remove_tile_msg");return}r.done(t._handleAfterSortable(function(){t._showLocalizedMessage("tile_deleted_msg");t._checkRequestQueue()}));r.fail(t._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_remove_tile_msg")))});f=true;return false}});if(f){return false}})},_moveTile:function(c,e,d){var t=this,n=d.toIndex,N=d.toGroupId,T=d.sTileId,o,a,O,b,f,h,G=this.oModel.getProperty("/groups");jQuery.each(G,function(j,k){var F=false;jQuery.each(k.tiles,function(l,m){if(m.uuid===T){o=m;a=l;O=k;b=j;F=true;return false}});if(F){return false}});jQuery.each(G,function(j,k){if(k.groupId===N){f=k;h=j;if(O.isDefaultGroup&&b!=h&&O.tiles.length<=1){t.toggleDefaultGroupVisibility(false)}}});if(n&&n>f.tiles.length){n=f.tiles.length}if(O.groupId===N){if(n===null||n===undefined){O.tiles.splice(a,1);n=O.tiles.length;O.tiles.push(o)}else{this._moveInArray(O.tiles,a,n)}this.oModel.setProperty("/groups/"+b+"/tiles",O.tiles)}else{O.tiles.splice(a,1);this.oModel.setProperty("/groups/"+b+"/tiles",O.tiles);if(n===null||n===undefined){n=f.tiles.length;f.tiles.push(o)}else{f.tiles.splice(n,0,o)}this.oModel.setProperty("/groups/"+h+"/tiles",f.tiles)}var s=this.oModel.getProperty("/groups/"+b).object,i=this.oModel.getProperty("/groups/"+h).object,r;this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.moveTile(o.object,a,n,s,i)}catch(j){this._resetGroupsOnFailure("fail_to_move_tile_msg");return}r.done(this._handleAfterSortable($.proxy(function(T,k){var l=this._getPathOfTile(T),m=this.oPageBuilderService;if(l){this._destroyTileModel(l);this.oModel.setProperty(l+"/object",k);this.oModel.setProperty(l+"/content",[m.getTileView(k)]);this.oModel.setProperty(l+"/target",m.getTileTarget(k)||"")}this._checkRequestQueue()},this,T)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_tile_msg")))},this))},toggleDefaultGroupVisibility:function(v){var d=this.oDashboardView.oDashboardGroupsBox.getGroups()[0],G=this.oGroupListView.oGroupList.getItems()[0];d.setVisible(v);if(G){G.setShow(v)}},getModel:function(){return this.oModel},getDashboardView:function(){return this.oDashboardView},getGroupListView:function(){return this.oGroupListView},loadAllCatalogs:function(c,e,d){if(!this.oModel.getProperty("/catalogs")||!sap.ushell.Container.getService("LaunchPage").isCatalogsValid()){var t=this;this.loadPersonalizedGroups();this._destroyAllGroupModels("/catalogs");this._destroyAllTileModels("/catalogTiles");this.oModel.setProperty("/catalogs",[]);this.oModel.setProperty("/catalogTiles",[]);sap.ushell.Container.getService("LaunchPage").getCatalogs().done($.proxy(this.setCatalogs,this,"/catalogs",[{title:g("all"),"static":true,tiles:[]}])).fail(t._showLocalizedErrorHelper("fail_to_load_catalog_msg"))}},setCatalogs:function(p,s,c){var t=this,a=sap.ushell.Container.getService("LaunchPage"),o=(s&&s.length)||0;this.oModel.setProperty(p,$.merge(s||[],$.map(c,function(C){return{title:a.getCatalogTitle(C),id:a.getCatalogId(C),"static":false,tiles:[]}})));$.each(c,$.proxy(function(i,C){a.getCatalogTiles(C).done($.proxy(this.setCatalogTiles,this,"/catalogTiles",true,{catalog:a.getCatalogTitle(C),id:a.getCatalogId(C),index:i})).fail(t._showLocalizedErrorHelper("fail_to_load_catalog_tiles_msg"))},this))},setCatalogTiles:function(p,a,d,c){var s=sap.ushell.Container.getService("LaunchPage");this.oModel.setProperty(p,$.merge((a&&this.oModel.getProperty(p))||[],$.map(c,function(C,t){return{src:C,catalog:d.catalog,catalogIndex:d.index*100000+t,catalogId:d.id,title:s.getCatalogTileTitle(C),keywords:(s.getCatalogTileKeywords(C)||[]).join(','),id:s.getCatalogTileId(C),size:s.getCatalogTileSize(C),content:[s.getCatalogTileView(C)]}})))},_showLocalizedMessage:function(m,p,t){sap.ushell.services.Message.show(t||sap.ushell.services.Message.Type.INFO,g(m),p)},_showLocalizedError:function(m,p){this._showLocalizedMessage(m,p,sap.ushell.services.Message.Type.ERROR)},_showLocalizedErrorHelper:function(m,p){var t=this;return function(){t._showLocalizedError(m,p)}},_resetGroupsOnFailureHelper:function(m){var t=this;return function(G){t._showLocalizedError(m);t._requestFailed();setTimeout(function(){t.loadGroupsFromArray(G)})}},_resetGroupsOnFailure:function(m){this._requestFailed();this._showLocalizedError(m);this.loadPersonalizedGroups();this.oModel.updateBindings(true)},loadGroupsFromArray:function(G){var t=this;this.oPageBuilderService.getDefaultGroup().done(function(d){var i,k=1;t._loadGroup(0,d);for(i=0;i<G.length;++i){if(G[i]!==d){t._loadGroup(k,G[i]);k++}}for(i=G.length;i<t.oModel.getProperty("/groups/length");++i){t._destroyGroupModel("/groups/"+i)}t.oModel.setProperty("/groups/length",G.length)}).fail(t._resetGroupsOnFailureHelper("fail_to_get_default_group_msg"))},_loadGroup:function(n,G){var t=this,s="/groups/"+n;this._destroyGroupModel(s);var o=this.oModel.getProperty(s+"/groupId"),N=this._getGroupModel(G,n===0);if(o){N.groupId=o}this.oModel.setProperty(s,N)},_getGroupModel:function(G,d){var s=this.oPageBuilderService,a=(G&&s.getGroupTiles(G))||[],m=[],i;for(i=0;i<a.length;++i){m.push(this._getTileModel(a[i]))}return{title:(d&&g("my_group"))||(G&&s.getGroupTitle(G))||"",object:G,groupId:jQuery.sap.uid(),tiles:m,isDefaultGroup:d||false,editMode:!G,removable:!G||s.isGroupRemovable(G),sortable:true}},_addTileToGroup:function(G,t){var s=this.oPageBuilderService,T=G+"/tiles",l=s.getTileSize(t),n=this.oModel.getProperty(T).length;this.oModel.setProperty(T+"/"+n,this._getTileModel(t))},_getTileModel:function(t){var s=this.oPageBuilderService,l=s.getTileSize(t);return{"object":t,"uuid":jQuery.sap.uid(),"content":[s.getTileView(t)],"long":((l!==null)&&(l==="1x2"||l==="2x2"))||false,"target":s.getTileTarget(t)||""}},_destroyAllGroupModels:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(G){for(i=0;i<G.length;i=i+1){this._destroyGroupModel(G[i])}}},_destroyGroupModel:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(G){this._destroyAllTileModels(G.tiles)}},_destroyAllTileModels:function(t){var T=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(T){for(i=0;i<T.length;i=i+1){this._destroyTileModel(T[i])}}},_destroyTileModel:function(t){var T=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(T&&T.content){for(i=0;i<T.content.length;i=i+1){T.content[i].destroy()}}},loadPersonalizedGroups:function(){var t=this,G=this.oPageBuilderService.getGroups();G.done(function(a){t.loadGroupsFromArray(a)});G.fail(t._showLocalizedErrorHelper("fail_to_load_groups_msg"))}})}());
