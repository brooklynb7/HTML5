// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.ui.launchpad.TileContainer");sap.ui.controller("sap.ushell.renderers.fiori2.launchpad.dashboard.DashboardContent",{onInit:function(){this.sViewId="#"+this.oView.getId()},onAfterRendering:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.unsubscribe("grouplist","GroupListOver",this._handleGroupListOver,this);e.unsubscribe("grouplist","GroupListOut",this._handleGroupListOut,this);e.unsubscribe("grouplist","GroupListItemOver",this._handleGroupListItemOver,this);e.unsubscribe("grouplist","GroupListItemOut",this._handleGroupListItemOut,this);e.unsubscribe("grouplist","GroupListItemDrop",this._handleGroupListItemDrop,this);e.subscribe("grouplist","GroupListOver",this._handleGroupListOver,this);e.subscribe("grouplist","GroupListOut",this._handleGroupListOut,this);e.subscribe("grouplist","GroupListItemOver",this._handleGroupListItemOver,this);e.subscribe("grouplist","GroupListItemOut",this._handleGroupListItemOut,this);e.subscribe("grouplist","GroupListItemDrop",this._handleGroupListItemDrop,this);jQuery("#__area0").appendTo("#shell-cntnt")},_scrollToGroup:function(c,e,d){var g=d.groupId,t=this;jQuery.each(this.oView.oDashboardGroupsBox.getGroups(),function(n,G){if(G.getGroupId()===g){if(n===0){sap.ui.getCore().byId("dashboardPage").scrollTo(0,500)}else{var y;if(jQuery.device.is.desktop){var j=jQuery("#dashboardPage-cont");y=jQuery.sap.byId(G.sId).offset().top+j.scrollTop()-76;sap.ui.getCore().byId("dashboardPage").scrollTo(y,500)}else{var D=sap.ui.getCore().byId("dashboardPage"),s=D.getScrollDelegate();s._scroller.scrollToElement("#"+G.sId+" .sapUshellContainerPositionAnchor",500)}}jQuery('#groupList .sapUshellDefaultGroupItem, #groupList .sapUshellGroupListItem').removeClass('sapUshellOver').eq(n).addClass('sapUshellOver');return false}})},makeGroupSortable:function(j){var a=j.find('.sapUshellInner');if(a.hasClass("ui-sortable")){return}this._sortable(a)},_getTileTopOffset:function(t){var T=0;T+=t.parents("#dashboardPage-cont").scrollTop();T+=t.parents(".sapUshellDashboardGroupsContainerItem").position().top;T+=t.position().top;return T},_sortable:function(j){var t=this,a=jQuery.sap.byId(this.oView.oDashboardGroupsBox.getId()),b=a.find(".sapUshellCloneArea");t.bActive=false;if(b.length<=0){b=jQuery("<div id='cloneArea' class='sapUshellCloneArea sapUshellDashboardGroupsContainerItem'></div>");a.append(b)}j.sortable({containment:"document",items:'>:not(.sapUshellPlusTile)',connectWith:".sapUshellInner.sapUshellTilesContainer-sortable",placeholder:"sapUshellTile-placeholder",tolerance:"pointer",helper:function(e,c){var d=c.clone();d.attr("id",d.attr("id")+'-helperclone');d.addClass("sapUshellSortableHelperClone");d.css("font-size",c.css("font-size"));d.hide();setTimeout(function(){d.appendTo('body');d.show()},1);return d},revert:jQuery.proxy(this._handleSortableRevert,this),start:jQuery.proxy(this._handleSortableStart,this),stop:jQuery.proxy(this._handleSortableStop,this),change:function(e,u){t._handleSortableChange(e,u,true)}}).disableSelection();if(jQuery.device.is.phone){j.sortable('disable')}},_bindTileEvents:function(e){var t=e.getSource();if(!jQuery.device.is.tablet){return}var a=this;jQuery.sap.byId(t.sId).bind("mousedown",function(b){if(a.bActive===false){jQuery(".sapUshellInner.sapUshellTilesContainer-sortable").sortable('disable');var _=jQuery(this),c=b;clearTimeout(a.fdownTimer);a.fdownTimer=setTimeout(function(){a.bActive=true;jQuery(_).effect("shake",{times:1,distance:5,complete:function(){if(!a.bActive){return}jQuery(".sapUshellInner.sapUshellTilesContainer-sortable").sortable('enable');var d=sap.ui.getCore().byId("dashboardPage"),s=d.getScrollDelegate();s._scroller.disable();jQuery(this).trigger(c)}},50)},150)}});jQuery.sap.byId(t.sId).bind('mouseup',$.proxy(a,'_resetDraggingTimeout')).bind('mousemove',$.proxy(a,'_resetDraggingTimeout')).bind('scrollstart',$.proxy(a,'_resetDraggingTimeout')).bind('touchmove',$.proxy(a,'_resetDraggingTimeout')).bind('touchcancel',$.proxy(a,'_resetDraggingTimeout'))},_resetDraggingTimeout:function(){clearTimeout(this.fdownTimer);this.bActive=false;if(!jQuery.device.is.desktop){var d=sap.ui.getCore().byId("dashboardPage"),s=d.getScrollDelegate();s._scroller.enable()}},_handleSortableRevert:function(e,u){return 250},_handleSortableStart:function(e,u){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");var t=sap.ui.getCore().byId(u.item[0].id),j=jQuery.sap.byId(this.oView.oDashboardGroupsBox.getId()),a=this,b=j.find("#cloneArea"),c=parseFloat(jQuery("#shell-container-canvas").css("left")),d=j.offset().left;if(t.getLong()){jQuery(".sapUshellTile-placeholder").addClass("sapUshellLong")}b.css("left",d-c);u.item.addClass("sapUshellExcludeMe");u.item.click(function(E){E.preventDefault();E.stopPropagation()});if(jQuery.device.is.desktop){j.find(".sapUshellDashboardGroupsContainerItem").not(".sapUshellCloneArea").each(function(){var f=jQuery(this);jQuery(this).find(".sapUshellTile").not(".sapUshellSortableHelperClone").each(function(){var t=jQuery(this),C=t.clone();C.attr("id",C.attr("id")+'-clone');C.css("font-size",t.css("font-size"));C.addClass("sapUshellClonedTile");C.click(function(E){E.preventDefault();E.stopPropagation()});t.data("clone",C);t.data("group",f);var T=parseInt(t.position().left)+parseInt(jQuery(".sapUshellDashboardGroupsContainer .sapUshellTileContainer").css("margin-left"))+"px",i=a._getTileTopOffset(t);C.css("left",T);C.css("top",i+"px");b.append(C)})});j.find(".sapUshellTile").not(".sapUshellSortableHelperClone").not(".sapUshellExcludeMe").not(".sapUshellClonedTile").css("visibility","hidden");u.item.data("clone").hide()}this.oView.oDashboardDeleteArea.show()},_handleSortableStop:function(e,u){jQuery(".sapUshellSortableHelperClone").remove();var t=u.item[0].id,T=sap.ui.getCore().byId(t),E=sap.ui.getCore().getEventBus();if(T){var o=T.getParent();if(!T.bDeletionFlag){if(T.getLong()){jQuery(".sapUshellTile-placeholder").removeClass("sapUshellLong")}var n=sap.ui.getCore().byId(u.item.parents(".sapUshellTileContainer").attr("id")),N=n.getGroupId(),a=u.item.index();o.removeTile(T,true);n.insertTile(T,a,true);E.publish("launchpad","moveTile",{sTileId:T.getUuid(),toGroupId:N,toIndex:a});u.item.parent().sortable('disable')}else if(T.bDeletionFlag){o.removeTile(T,true);T.bDeletionFlag=false;E.publish("launchpad","deleteTile",{tileId:T.getUuid()});T.destroy()}}this.oView.oDashboardDeleteArea.hide();if(jQuery.device.is.desktop){var j=jQuery(".sapUshellTile").not(".sapUshellClonedTile");j.removeData("clone");j.removeClass("sapUshellExcludeMe");j.css("visibility","visible");var b=jQuery.sap.byId(this.oView.oDashboardGroupsBox.getId()),c=b.find("#cloneArea");c.empty()}if(jQuery.device.is.phone){that.bActive=false;jQuery(".sapUshellInner.sapUshellTilesContainer-sortable").sortable('disable')}E.publish("launchpad","sortableStop")},_handleSortableChange:function(e,u,a){var t=this,j=jQuery.sap.byId(this.oView.oDashboardGroupsBox.getId());var o=j.find(".sapUshellTile");o=o.not(".sapUshellExcludeMe");o=o.not(".sapUshellTile-placeholder");o=o.not(".sapUshellTile-placeholder.sapUshellLong");o=o.not(".sapUshellClonedTile");if(u&&u.sender){var b=u.placeholder;if(b.length>0){var c=b.first().parent();if(c){var d=c.find(".sapUshellPlusTile");if(d.length>0){d.detach();c.append(d)}}}}o.each(function(){var T=jQuery(this),C=T.data("clone");if(!C){return false}var s=parseInt(T.position().left)+parseInt(jQuery(".sapUshellDashboardGroupsContainer .sapUshellTileContainer").css("margin-left"))+"px",i=t._getTileTopOffset(T);if(a){C.stop(true,false);C.animate({left:s,top:i+"px"},{duration:250},{easing:"swing"})}else{C.css("left",s);C.css("top",i+"px")}})},_handleGroupListOver:function(c,e,E){jQuery(".sapUshellSortableHelperClone").toggleClass("sapUshellOverGroupList");jQuery(".sapUshellTile-placeholder").hide()},_handleGroupListOut:function(c,e,E){jQuery(".sapUshellSortableHelperClone").toggleClass("sapUshellOverGroupList");jQuery(".sapUshellTile-placeholder").show();jQuery(".sapUshellGroupList").data("dropGroup",null);this._handleSortableChange(undefined,undefined,false)},_handleGroupListItemOver:function(c,e,E){jQuery(".sapUshellGroupList").data("dropGroup",E.getSource());var j=jQuery(".sapUshellTile-placeholder").not(".sapUshellPlaceholderClone").clone();j.addClass("sapUshellPlaceholderClone");j.attr("id","placeholder-clone_"+E.getSource().sId);var a;jQuery.each(this.oView.oDashboardGroupsBox.getGroups(),function(n,g){if(g.getGroupId()===E.getSource().getGroupId()){a=jQuery("#"+g.sId).find(".sapUshellTilesContainer-sortable");return false}});if(a.find(".sapUshellPlusTile").length>0){a.find(".sapUshellPlusTile").before(j);j.show()}else{a.append(j);j.show()}jQuery(".sapUshellExcludeMe.sapUshellSortableHelperClone").hide();jQuery(".sapUshellTile-placeholder").not(".sapUshellPlaceholderClone").hide();this._handleSortableChange(undefined,undefined,false)},_handleGroupListItemOut:function(c,e,E){jQuery("#placeholder-clone_"+E.getSource().sId).remove();this._handleSortableChange(undefined,undefined,false)},_handleGroupListItemDrop:function(c,e,E){var t=E.getParameter("control"),o=t.getParent();o.removeTile(t,true);this._publishAsync("launchpad","moveTile",{sTileId:t.getUuid(),toGroupId:E.getSource().getGroupId(),toIndex:null});this._handleGroupListOut(c,e,E);this._handleGroupListItemOut(c,e,E);t.destroy()},_publishAsync:function(c,e,d){var b=sap.ui.getCore().getEventBus();window.setTimeout($.proxy(b.publish,b,c,e,d),1)},})}());
