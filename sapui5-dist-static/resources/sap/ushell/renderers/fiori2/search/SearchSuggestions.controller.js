// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.search.SearchSuggestions",{onInit:function(){var m=new sap.ui.model.json.JSONModel();this.getView().setModel(m,"suggestions");this.closeSuggestions();if(jQuery.device.is.phone||jQuery.device.is.tablet){this.suggestionLimit=4}else{this.suggestionLimit=5}sap.ui.getCore().getEventBus().subscribe("searchSuggest",this.doSuggestion,this);sap.ui.getCore().getEventBus().subscribe("search",this.closeSuggestions,this)},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("searchSuggest",this.doSuggestion,this);sap.ui.getCore().getEventBus().unsubscribe("search",this.closeSuggestions,this)},closeSuggestions:function(c,e,d){this.getView().getModel("suggestions").setData({items:[{visible:false,type:"suggestion"},{visible:false,type:"suggestion"},{visible:false,type:"suggestion"},{visible:false,type:"suggestion"},{visible:false,type:"suggestion"},{visible:false,type:"suggestion",isGroupFooter:true},{visible:false,type:"app",isGroupHeader:true,label:sap.ushell.resources.i18n.getText("suggestion_found_apps")},{visible:false,type:"app"}],suggestionsVisible:false,visible:false})},dataSourceSelected:function(c,e,d){if(this.getView().getModel("suggestions").getProperty("/visible")){this.doSuggestion(null,null,{searchTerm:this.lastSearchTerm})}},onClickSuggestion:function(e){var s=e.getSource().getBindingContext("suggestions").getObject(),d,S,c=false;if(s.type==="app"){if(s.targetURL){window.location=s.targetURL}}else{if(s.data){S=s.data.labelRaw;d=s.data.dataSource;d.label=d.objectName.label;c=true}else{S=s.labelRaw;d={label:"All",level:0,objectName:{label:"ALL",value:"$$ALL$$"},packageName:{label:"ABAP",value:"ABAP"},schemaName:{label:"",value:""},type:{label:"Category",value:"Category"}}}sap.ui.getCore().getEventBus().publish("externalSearch",{searchTerm:S,dataSource:d,categorySuggested:c})}},doSuggestion:function(c,e,d){var f=new sap.ui.model.Filter("visible",sap.ui.model.FilterOperator.EQ,true),m=this.getView().getModel("suggestions"),a,q;if(d.activeViews&&d.activeViews.indexOf(this.getView().getId())===-1){return}this.lastSearchTerm=d.searchTerm;if(d.searchTerm.length===0){this.closeSuggestions()}if(d.searchTerm.length<3){return}m.setProperty("/visible",true);a=sap.ushell.Container.getService("Search").queryApplications(d.searchTerm,jQuery.proxy(function(r){var b=r.getElements();if(r.searchTerm!==this.lastSearchTerm){return}if(b.length>0){m.setProperty("/items/6/visible",true);m.setProperty("/items/7",{label:b[0].label,icon:b[0].icon,targetURL:b[0].targetURL,app:b[0],visible:true,type:"app"})}else{m.setProperty("/items/6/visible",false);m.setProperty("/items/7/visible",false)}this.getView().getContent()[0].getBinding("items").filter([f])},this),1);q=sap.ushell.Container.getService("Search").querySuggestions(d.searchTerm,jQuery.proxy(function(r){var s=r.getElements(),S=[],i=0;if(r.searchTerm!==this.lastSearchTerm){return}if(s.length>0){S=this.buildSuggestions(s);m.setProperty("/suggestionsVisible",true)}else{m.setProperty("/suggestionsVisible",false)}for(i;i<4;i=i+1){if(S[i]&&i<(this.suggestionLimit-1)){m.setProperty("/items/"+i,S[i])}else{m.setProperty("/items/"+i+"/visible",false)}}if(S.length>0){m.setProperty("/items/"+(i+1),{visible:true,type:"suggestion",isGroupFooter:true})}else{m.setProperty("/items/"+(i+1)+"/visible",false)}this.getView().getContent()[0].getBinding("items").filter([f])},this))},buildSuggestions:function(s){var r={};jQuery.each(s,function(i,v){if(v.filter.attribute!=="$$AllAttributes$$"){return}if(!r[v.labelRaw]){r[v.labelRaw]=v;r[v.labelRaw].categories=[];r[v.labelRaw].visible=true;r[v.labelRaw].type="suggestion"}if(r[v.labelRaw].label.length===0){r[v.labelRaw].label=v.labelRaw}if(v.dataSource.getObjectName().value!=="$$AllDataSources$$"){r[v.labelRaw].categories.push({label:v.dataSource.getObjectName().label,data:v})}});return jQuery.map(r,function(k,v){return[k]})}})}());
