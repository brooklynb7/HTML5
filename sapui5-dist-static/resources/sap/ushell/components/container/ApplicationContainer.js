//Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";var p="sap.ushell.components.container.",c=p+"ApplicationContainer",r;jQuery.sap.declare("sap.ushell.components.container.ApplicationContainer");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.ui.core.UIComponent");jQuery.sap.require("sap.m.InstanceManager");sap.ushell.components.container.ApplicationType={URL:"URL",WDA:"WDA"};sap.ushell.utils.testPublishAt(sap.ushell.components.container);function g(u){return jQuery.sap.getUriParameters(u).mParams}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function a(k,A){if(!r){r=jQuery.sap.resources({url:jQuery.sap.getModulePath(p)+"/resources/resources.properties",language:sap.ui.getCore().getConfiguration().getLanguage()})}return r.getText(k,A)}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function b(){return new sap.ui.core.Icon({size:"2rem",src:"sap-icon://error",tooltip:a("an_error_has_occured")})}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function d(C){var o=C.getAggregation("child"),s;if(o instanceof sap.ui.core.ComponentContainer){s=o.getComponentInstance().getMetadata().getName().replace(/\.Component$/,"");jQuery.sap.log.debug("unloading component "+s,null,c)}C.destroyAggregation("child");if(s){sap.ui.core.Component.deactivateCustomizing(s)}if(sap.m.InstanceManager.hasOpenPopover()){sap.m.InstanceManager.closeAllPopovers()}if(sap.m.InstanceManager.hasOpenDialog()){jQuery.sap.log.warning("Found open dialogs after destruction of component '"+s+"'. Dialogs must be destroyed in component exit handler.",null,c);sap.m.InstanceManager.closeAllDialogs()}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function e(C,u,A){var o,j,I,l,m,n,v,V,s;I=u.indexOf("?");if(I>=0){v=g(u);u=u.slice(0,I)}if(u.slice(-1)!=='/'){u+='/'}if(/\.view\.(\w+)$/i.test(A)){m=/^SAPUI5=(?:([^\/]+)\/)?([^\/]+)\.view\.(\w+)$/i.exec(A);if(!m){jQuery.sap.log.error("Invalid SAPUI5 URL",A,c);return b()}n=m[1];V=m[2];s=m[3].toUpperCase();if(n){V=n+"."+V}else{l=V.lastIndexOf(".");if(l<1){jQuery.sap.log.error("Missing namespace",A,c);return b()}n=V.slice(0,l)}}else{n=A.replace(/^SAPUI5=/,"")}jQuery.sap.registerModulePath(n,u+n.replace(/\./g,'/'));d(C);if(V){j=sap.ui.view({id:C.getId()+"-content",type:s,viewData:v||{},viewName:V})}else{jQuery.sap.log.debug("loading component "+n,null,c);sap.ui.core.Component.activateCustomizing(n);o=sap.ui.component({id:C.getId()+"-component",componentData:v?{startupParameters:v}:{},name:n});j=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:o})}j.setWidth(C.getWidth());j.setHeight(C.getHeight());j.addStyleClass("sapUShellApplicationContainer");C.setAggregation("child",j,true);return j}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function f(C,u,s){var I,m,o,j,k={};I=u.indexOf("?");if(I>=0){k={startupParameters:g(u)};u=u.slice(0,I)}if(u.slice(-1)!=='/'){u+='/'}jQuery.sap.registerModulePath(s,u);jQuery.sap.require("sap.ushell.services.CrossApplicationNavigation");d(C);jQuery.sap.log.debug("loading component "+s,null,c);sap.ui.core.Component.activateCustomizing(s);o=sap.ui.component({id:C.getId()+"-component",name:s,componentData:k});j=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:o});j.setHeight(C.getHeight());j.setWidth(C.getWidth());j.addStyleClass("sapUShellApplicationContainer");C.setAggregation("child",j,true);return j}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function h(R,C,o){R.write("<div").writeControlData(C).writeAccessibilityState(C).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write(">").renderControl(o);R.write("</div>")}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function i(R,C,A,u,s){if(s&&s.indexOf("SAPUI5.Component=")===0&&A===sap.ushell.components.container.ApplicationType.URL){h(R,C,f(C,u,s.replace(/^SAPUI5\.Component=/,"")));return}if(s&&s.indexOf("SAPUI5=")===0&&A===sap.ushell.components.container.ApplicationType.URL){h(R,C,e(C,u,s));return}jQuery.sap.log.debug("Not resolved as \"SAPUI5.Component=\" or \"SAPUI5=\" , "+"will attempt to load into iframe "+s);try{u=C.getFrameSource(A,u,s)}catch(j){jQuery.sap.log.error(j.message||j,null,c);R.renderControl(b());return}R.write("<iframe").writeControlData(C).writeAccessibilityState(C).writeAttribute("sandbox","allow-forms allow-same-origin allow-scripts").writeAttributeEscaped("src",u).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write("></iframe>")}sap.ui.core.Control.extend(c,{metadata:{properties:{additionalInformation:{defaultValue:"",type:"string"},application:{type:"object"},applicationType:{defaultValue:"URL",type:p+"ApplicationType"},height:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},url:{defaultValue:"",type:"string"},visible:{defaultValue:true,type:"boolean"},width:{defaultValue:"100%",type:"sap.ui.core.CSSSize"}},aggregations:{child:{multiple:false,type:"sap.ui.core.Control",visibility:"hidden"}},library:"sap.ushell"},exit:function(){d(this);if(sap.ui.core.Control.exit){sap.ui.core.Control.exit.apply(this)}},renderer:function(R,C){var A=C.getApplication(),l=C.launchpadData,L;if(!C.getVisible()){h(R,C);return}if(C.error){delete C.error;h(R,C,b())}else if(!A){i(R,C,C.getApplicationType(),C.getUrl(),C.getAdditionalInformation())}else if(!A.isResolvable()){i(R,C,A.getType(),A.getUrl(),"")}else if(l){i(R,C,l.applicationType,l.Absolute.url.replace(/\?$/,""),l.applicationData)}else{jQuery.sap.log.debug("Resolving "+A.getUrl(),null,c);A.resolve(function(o){jQuery.sap.log.debug("Resolved "+A.getUrl(),JSON.stringify(o),c);C.launchpadData=o;d(C)},function(E){var j=A.getMenu().getDefaultErrorHandler();if(j){j(E)}d(C);C.error=E});L=new sap.m.Text({text:a("loading",[A.getText()])});d(C);C.setAggregation("child",L);h(R,C,L)}}});sap.ushell.components.container.ApplicationContainer.prototype.getFrameSource=function(A,u,s){if(!Object.prototype.hasOwnProperty.call(sap.ushell.components.container.ApplicationType,A)){throw new Error("Illegal application type: "+A)}return u}}());
